(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=n(t);fetch(t.href,s)}})();function w(){const a=window;if(!a.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return a.Telegram.WebApp}function T(a){const e=w();return new Promise(n=>{e.CloudStorage.getItem(a,(o,t)=>{n(o||!t?null:t)})})}function v(a,e){const n=w();return new Promise((o,t)=>{n.CloudStorage.setItem(a,e,s=>{s?t(s):o()})})}const C="fs_token";async function N(){return await T(C)}async function L(a){await v(C,a)}async function b(){await v(C,"")}async function M(a){const e=window.location.origin,n=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:a})});if(!n.ok){const t=await n.json().catch(()=>({}));throw new Error(t.error??"Exchange failed")}return(await n.json()).token}class B{constructor(e){this.token=e,this.baseUrl=`${window.location.origin}/plugins/telegram-files/api`}async request(e,n,o){const t={method:e,headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"}};o!==void 0&&(t.body=JSON.stringify(o));const s=await fetch(`${this.baseUrl}${n}`,t),i=await s.json();if(!s.ok)throw new Error(i.error??`HTTP ${s.status}`);return i}async ls(e){const n=encodeURIComponent(e);return await this.request("GET",`/ls?path=${n}`)}async read(e){const n=encodeURIComponent(e);return await this.request("GET",`/read?path=${n}`)}async write(e,n){await this.request("POST","/write",{path:e,content:n})}async delete(e){const n=encodeURIComponent(e);await this.request("DELETE",`/delete?path=${n}`)}}function S(a){const{container:e,currentPath:n,items:o,onNavigate:t,onFileOpen:s}=a;e.innerHTML="";const i=document.createElement("div");if(i.className="path-header",i.textContent=n,e.appendChild(i),o.length===0){const r=document.createElement("div");r.className="status-message",r.textContent="Empty directory",e.appendChild(r);return}const l=document.createElement("div");l.className="file-list";for(const r of o){const u=document.createElement("div");u.className="file-item";const d=document.createElement("span");d.className="file-icon",d.textContent=r.isDir?"ðŸ“":r.isSymlink?"ðŸ”—":P(r.name);const f=document.createElement("div");f.className="file-info";const c=document.createElement("div");if(c.className="file-name",c.textContent=r.name,f.appendChild(c),u.appendChild(d),u.appendChild(f),r.isDir)u.addEventListener("click",()=>{const p=n==="/"?`/${r.name}`:`${n}/${r.name}`;t(p)});else if(r.isFile){const p=document.createElement("span");p.className="file-badge exists",p.textContent="edit",u.appendChild(p),u.addEventListener("click",()=>{const h=n==="/"?`/${r.name}`:`${n}/${r.name}`;s(h)})}l.appendChild(u)}e.appendChild(l)}async function $(a){const{container:e,client:n,dirPath:o,onNavigate:t,onFileOpen:s}=a;e.innerHTML='<div class="status-message">Loading...</div>';try{const i=await n.ls(o);S({container:e,currentPath:i.path,items:i.items,onNavigate:t,onFileOpen:s})}catch(i){e.innerHTML=`<div class="status-message error-text">Failed: ${i.message}</div>`}}function P(a){const e=a.toLowerCase();return e.endsWith(".md")?"ðŸ“":e.endsWith(".json")||e.endsWith(".json5")?"âš™ï¸":e.endsWith(".ts")||e.endsWith(".js")?"ðŸ“œ":e.endsWith(".sh")?"ðŸš":e.endsWith(".log")?"ðŸ“‹":e.startsWith(".")?"ðŸ”§":"ðŸ“„"}function O(a){const{container:e,client:n,filePath:o,webapp:t,onBack:s}=a;e.innerHTML="";const i=document.createElement("div");i.className="editor-container";const l=document.createElement("div");l.className="editor-header";const r=document.createElement("span");r.className="editor-filename";const u=o.split("/");r.textContent=u[u.length-1]||o;const d=document.createElement("span");d.className="editor-status",d.textContent="Loading...",l.appendChild(r),l.appendChild(d);const f=document.createElement("div");f.className="file-meta",f.style.padding="0 0 8px",f.textContent=o;const c=document.createElement("textarea");c.className="editor-textarea",c.placeholder="Loading...",c.disabled=!0,c.spellcheck=!1,i.appendChild(l),i.appendChild(f),i.appendChild(c),e.appendChild(i);let p="",h=!1;c.addEventListener("input",()=>{const m=c.value!==p;m!==h&&(h=m,d.textContent=h?"Modified":"Saved",h?(t.MainButton.setText("Save"),t.MainButton.show()):t.MainButton.hide())}),t.BackButton.show();const y=()=>{h&&!confirm("You have unsaved changes. Discard?")||(k(),s())};t.BackButton.onClick(y);const E=async()=>{t.MainButton.showProgress(!0),t.MainButton.disable(),d.textContent="Saving...";try{await n.write(o,c.value),p=c.value,h=!1,d.textContent="Saved",t.MainButton.hide()}catch(m){d.textContent=`Error: ${m.message}`}finally{t.MainButton.hideProgress(),t.MainButton.enable()}};t.MainButton.onClick(E);function k(){t.BackButton.hide(),t.BackButton.offClick(y),t.MainButton.hide(),t.MainButton.offClick(E)}x();async function x(){try{const m=await n.read(o);p=m.content,c.value=m.content,c.disabled=!1,d.textContent="Ready"}catch(m){d.textContent=`Error: ${m.message}`,c.placeholder="Failed to load file."}}}function F(a,e){const n=w();let o="/";t("/home");function t(i){if(o=i,n.BackButton.hide(),n.MainButton.hide(),i!=="/"){n.BackButton.show();const l=()=>{n.BackButton.offClick(l);const r=i.substring(0,i.lastIndexOf("/"))||"/";t(r)};n.BackButton.onClick(l)}$({container:a,client:e,dirPath:i,onNavigate:l=>t(l),onFileOpen:l=>s(l)})}function s(i){O({container:a,client:e,filePath:i,webapp:n,onBack:()=>t(o)})}}async function W(){const a=document.getElementById("app"),e=w();e.ready(),e.expand(),g(a,"Connecting...");try{const n=await A();g(a,"Loading...");const o=new B(n);await o.ls("/home"),a.innerHTML="",F(a,o)}catch(n){g(a,`Connection failed: ${n.message}`,!0)}}async function A(){try{const o=await N();if(o){const t=new B(o);try{return await t.ls("/"),o}catch{try{await b()}catch{}}}}catch{}const a=new URL(window.location.href),e=a.searchParams.get("pair");if(!e)throw new Error("No saved token. Send /files in Telegram to get started.");const n=await M(e);try{await L(n)}catch{}return a.searchParams.delete("pair"),window.history.replaceState({},"",a.toString()),n}function g(a,e,n=!1){a.innerHTML=`<div class="status-message ${n?"error-text":""}">${H(e)}</div>`}function H(a){const e=document.createElement("div");return e.textContent=a,e.innerHTML}W();
