(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();function w(){const i=window;if(!i.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return i.Telegram.WebApp}function y(i){const e=w();return new Promise(s=>{e.CloudStorage.getItem(i,(a,t)=>{s(a||!t?null:t)})})}function E(i,e){const s=w();return new Promise((a,t)=>{s.CloudStorage.setItem(i,e,n=>{n?t(n):a()})})}const v="gw_token",x="gw_ws_url";async function k(){const i=await y(v),e=await y(x);return i&&e?{token:i,wsUrl:e}:null}async function L(i){await E(v,i.token),await E(x,i.wsUrl)}async function S(i){const e=window.location.origin,s=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:i})});if(!s.ok){const t=await s.json().catch(()=>({}));throw new Error(t.error??"Exchange failed")}const a=await s.json();return{token:a.token,wsUrl:a.wsUrl}}class M{constructor(e,s){this.ws=null,this.nextId=1,this.pending=new Map,this.connected=!1,this.token=e,this.wsUrl=s}connect(){return new Promise((e,s)=>{try{this.ws=new WebSocket(this.wsUrl)}catch(a){s(new Error(`WebSocket connection failed: ${a}`));return}this.ws.onopen=async()=>{try{await this.call("connect",{token:this.token}),this.connected=!0,e()}catch(a){s(a)}},this.ws.onmessage=a=>{try{const t=JSON.parse(a.data);if(t.id&&this.pending.has(t.id)){const n=this.pending.get(t.id);this.pending.delete(t.id),t.error?n.reject(new Error(t.error.message??"RPC error")):n.resolve(t.result)}}catch{}},this.ws.onerror=()=>{this.connected||s(new Error("WebSocket error"))},this.ws.onclose=()=>{this.connected=!1;for(const[,a]of this.pending)a.reject(new Error("Connection closed"));this.pending.clear()}})}call(e,s){return new Promise((a,t)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){t(new Error("Not connected"));return}const n=String(this.nextId++);this.pending.set(n,{resolve:a,reject:t}),this.ws.send(JSON.stringify({jsonrpc:"2.0",id:n,method:e,params:s})),setTimeout(()=>{this.pending.has(n)&&(this.pending.delete(n),t(new Error("RPC timeout")))},15e3)})}async listFiles(e){return(await this.call("agents.files.list",{agentId:e}))?.files??[]}async getFile(e,s){return(await this.call("agents.files.get",{agentId:e,name:s}))?.content??""}async setFile(e,s,a){await this.call("agents.files.set",{agentId:e,name:s,content:a})}async listAgents(){return(await this.call("agents.list",{}))?.agents??[]}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}get isConnected(){return this.connected}}function b(i){const{container:e,files:s,agentId:a,onFileClick:t}=i;e.innerHTML="";const n=document.createElement("h1");n.className="page-header",n.textContent="Files",e.appendChild(n);const r=document.createElement("div");if(r.className="file-meta",r.style.paddingBottom="8px",r.textContent=`Agent: ${a}`,e.appendChild(r),s.length===0){const o=document.createElement("div");o.className="status-message",o.innerHTML='<span class="emoji">ğŸ“‚</span>No files found for this agent.',e.appendChild(o);return}const l=document.createElement("div");l.className="file-list";for(const o of s){const u=document.createElement("div");u.className="file-item",u.addEventListener("click",()=>t(o.name));const d=document.createElement("span");d.className="file-icon",d.textContent=T(o.name);const c=document.createElement("div");c.className="file-info";const h=document.createElement("div");h.className="file-name",h.textContent=o.name;const f=document.createElement("div");f.className="file-meta",f.textContent=o.sizeBytes!=null?I(o.sizeBytes):"",c.appendChild(h),c.appendChild(f);const p=document.createElement("span");p.className=`file-badge ${o.exists?"exists":"missing"}`,p.textContent=o.exists?"exists":"create",u.appendChild(d),u.appendChild(c),u.appendChild(p),l.appendChild(u)}e.appendChild(l)}async function F(i){const{container:e,client:s,agentId:a,onFileClick:t}=i;e.innerHTML='<div class="status-message">Loading files...</div>';try{const n=await s.listFiles(a);b({container:e,files:n,agentId:a,onFileClick:t})}catch(n){e.innerHTML=`<div class="status-message error-text">Failed to load files: ${n.message}</div>`}}function T(i){const e=i.toLowerCase();return e.endsWith(".md")?"ğŸ“":e.includes("soul")?"ğŸ§ ":e.includes("tool")?"ğŸ”§":e.includes("config")?"âš™ï¸":e.includes("memory")?"ğŸ’¾":"ğŸ“„"}function I(i){return i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(1)} MB`}function P(i){const{container:e,client:s,agentId:a,fileName:t,webapp:n,onBack:r}=i;e.innerHTML="";const l=document.createElement("div");l.className="editor-container";const o=document.createElement("div");o.className="editor-header";const u=document.createElement("span");u.className="editor-filename",u.textContent=t;const d=document.createElement("span");d.className="editor-status",d.textContent="Loading...",o.appendChild(u),o.appendChild(d);const c=document.createElement("textarea");c.className="editor-textarea",c.placeholder="Loading file content...",c.disabled=!0,c.spellcheck=!1,l.appendChild(o),l.appendChild(c),e.appendChild(l);let h="",f=!1;c.addEventListener("input",()=>{const m=c.value!==h;m!==f&&(f=m,d.textContent=f?"Modified":"Saved",f?(n.MainButton.setText("Save"),n.MainButton.show()):n.MainButton.hide())}),n.BackButton.show();const p=()=>{f&&!confirm("You have unsaved changes. Discard?")||(B(),r())};n.BackButton.onClick(p);const C=async()=>{n.MainButton.showProgress(!0),n.MainButton.disable(),d.textContent="Saving...";try{await s.setFile(a,t,c.value),h=c.value,f=!1,d.textContent="Saved",n.MainButton.hide()}catch(m){d.textContent=`Error: ${m.message}`}finally{n.MainButton.hideProgress(),n.MainButton.enable()}};n.MainButton.onClick(C);function B(){n.BackButton.hide(),n.BackButton.offClick(p),n.MainButton.hide(),n.MainButton.offClick(C)}N();async function N(){try{const m=await s.getFile(a,t);h=m,c.value=m,c.disabled=!1,d.textContent=m?"Ready":"New file"}catch(m){d.textContent=`Error: ${m.message}`,c.placeholder="Failed to load file content."}}}async function $(i,e){const s=w();if(e.agents.length>1){const r=document.createElement("div");r.className="agent-selector";for(const l of e.agents){const o=document.createElement("button");o.className=`agent-chip ${l.id===e.agentId?"active":""}`,o.textContent=l.name??l.id,o.addEventListener("click",()=>{e.agentId=l.id,r.querySelectorAll(".agent-chip").forEach(u=>u.classList.remove("active")),o.classList.add("active"),t()}),r.appendChild(o)}i.appendChild(r)}const a=document.createElement("div");a.style.flex="1",a.style.display="flex",a.style.flexDirection="column",i.appendChild(a),t();function t(){s.BackButton.hide(),s.MainButton.hide(),F({container:a,client:e.client,agentId:e.agentId,onFileClick:r=>n(r)})}function n(r){P({container:a,client:e.client,agentId:e.agentId,fileName:r,webapp:s,onBack:()=>t()})}}async function O(){const i=document.getElementById("app"),e=w();e.ready(),e.expand(),g(i,"Connecting...");try{const s=await A();g(i,"Connecting to gateway...");const a=new M(s.token,s.wsUrl);await a.connect();const t=await a.listAgents();if(t.length===0){g(i,"No agents found. Create an agent first.",!0);return}i.innerHTML="",await $(i,{client:a,agentId:t[0].id,agents:t})}catch(s){g(i,`Connection failed: ${s.message}`,!0)}}async function A(){const i=await k();if(i)return i;const e=new URL(window.location.href),s=e.searchParams.get("pair");if(!s)throw new Error("No saved token and no pairing code. Send /files in Telegram to get started.");const a=await S(s);return await L(a),e.searchParams.delete("pair"),window.history.replaceState({},"",e.toString()),a}function g(i,e,s=!1){i.innerHTML=`<div class="status-message ${s?"error-text":""}">${W(e)}</div>`}function W(i){const e=document.createElement("div");return e.textContent=i,e.innerHTML}O();
