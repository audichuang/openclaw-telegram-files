(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();function W(){const s=window;if(!s.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return s.Telegram.WebApp}function q(s){const e=W();return new Promise(t=>{e.CloudStorage.getItem(s,(a,n)=>{t(a||!n?null:n)})})}function j(s,e){const t=W();return new Promise((a,n)=>{t.CloudStorage.setItem(s,e,i=>{i?n(i):a()})})}const U="fs_token";async function G(){return await q(U)}async function J(s){await j(U,s)}async function H(){await j(U,"")}async function K(s){const e=window.location.origin,t=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:s})});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.error??"Exchange failed")}return(await t.json()).token}class O{constructor(e){this.token=e,this.baseUrl=`${window.location.origin}/plugins/telegram-files/api`}async request(e,t,a){const n={Authorization:`Bearer ${this.token}`},i={method:e,headers:n};a!==void 0&&(n["Content-Type"]="application/json",i.body=JSON.stringify(a));const r=await fetch(`${this.baseUrl}${t}`,i);let c;if((r.headers.get("content-type")??"").includes("application/json")?c=await r.json():c={error:await r.text()||`HTTP ${r.status}`},!r.ok)throw new Error(c.error??`HTTP ${r.status}`);return c}async ls(e){const t=encodeURIComponent(e);return await this.request("GET",`/ls?path=${t}`)}async read(e){const t=encodeURIComponent(e);return await this.request("GET",`/read?path=${t}`)}async write(e,t){await this.request("POST","/write",{path:e,content:t})}async delete(e){const t=encodeURIComponent(e);await this.request("DELETE",`/delete?path=${t}`)}async mkdir(e){await this.request("POST","/mkdir",{path:e})}async home(){return await this.request("GET","/home")}async upload(e,t){const a=encodeURIComponent(e),n=encodeURIComponent(t.name),i=await fetch(`${this.baseUrl}/upload?dir=${a}&name=${n}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:t});let r;if((i.headers.get("content-type")??"").includes("application/json")?r=await i.json():r={error:await i.text()||`HTTP ${i.status}`},!i.ok)throw new Error(r.error??`HTTP ${i.status}`)}async search(e,t){const a=encodeURIComponent(e),n=encodeURIComponent(t);return await this.request("GET",`/search?path=${a}&q=${n}`)}}function Y(s){if(s<=0)return"0 B";const e=["B","KB","MB","GB"],t=Math.min(Math.floor(Math.log(s)/Math.log(1024)),e.length-1),a=s/Math.pow(1024,t);return`${a<10?a.toFixed(1):Math.round(a)} ${e[t]}`}function _(s){if(!s)return"";const e=Date.now()-s,t=Math.floor(e/1e3);if(t<60)return"just now";const a=Math.floor(t/60);if(a<60)return`${a}m ago`;const n=Math.floor(a/60);if(n<24)return`${n}h ago`;const i=Math.floor(n/24);if(i<7)return`${i}d ago`;const r=new Date(s);return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][r.getMonth()]} ${r.getDate()}`}function Q(s){const{container:e,currentPath:t,items:a,client:n,homeDir:i,onNavigate:r,onFileOpen:c,onRefresh:u}=s;e.innerHTML="";const d=document.createElement("div");d.style.cssText="font-size:10px;color:#999;word-break:break-all;padding:4px 8px;background:#f5f5f5;border-radius:4px;margin-bottom:4px;",d.textContent=`URL: ${window.location.href}`,e.appendChild(d);const m=document.createElement("div");m.className="list-toolbar";const y=document.createElement("div");y.className="path-header";const p=t.split("/").filter(Boolean);for(let o=0;o<p.length;o++){if(o>0){const g=document.createElement("span");g.className="breadcrumb-sep",g.textContent=" / ",y.appendChild(g)}const l="/"+p.slice(0,o+1).join("/"),h=document.createElement("span");h.textContent=p[o],o===p.length-1?h.className="breadcrumb-current":l.length>=i.length&&l.startsWith(i)?(h.className="breadcrumb-link",h.addEventListener("click",()=>r(l))):h.className="breadcrumb-disabled",y.appendChild(h)}p.length===0&&(y.textContent="/");const $=document.createElement("button");$.className="toggle-hidden-btn";const b=localStorage.getItem("tgfiles-show-hidden")==="1";$.textContent=b?"Hide .*":"Show .*",$.addEventListener("click",()=>{const o=localStorage.getItem("tgfiles-show-hidden")==="1"?"0":"1";localStorage.setItem("tgfiles-show-hidden",o),u()}),m.appendChild(y),m.appendChild($),e.appendChild(m);const L=document.createElement("div");L.className="search-bar";const N=document.createElement("input");N.type="text",N.placeholder="Search files...",N.className="search-input",L.appendChild(N),e.appendChild(L);const C=document.createElement("div");C.className="search-results",C.style.display="none",e.appendChild(C);let P=null,F=0;N.addEventListener("input",()=>{P&&clearTimeout(P);const o=N.value.trim();if(!o){C.style.display="none",k.style.display="",E.style.display="";return}P=setTimeout(async()=>{const l=++F;C.innerHTML="";const h=document.createElement("div");h.className="status-message",h.textContent="Searching...",C.appendChild(h),C.style.display="",k.style.display="none",E.style.display="none";try{const g=await n.search(t,o);if(l!==F)return;V(C,g.results,r,c)}catch(g){if(l!==F)return;C.innerHTML="";const S=document.createElement("div");S.className="status-message error-text",S.textContent=`Search failed: ${g.message}`,C.appendChild(S)}},300)});const k=document.createElement("div");k.className="file-list";const w=b?a:a.filter(o=>!o.name.startsWith("."));if(w.length===0){const o=document.createElement("div");o.className="status-message",o.textContent="Empty directory",k.appendChild(o)}else for(const o of w){const l=document.createElement("div");l.className="file-item";const h=document.createElement("span");h.className="file-icon",h.textContent=o.isDir?"ðŸ“":o.isSymlink?"ðŸ”—":z(o.name);const g=document.createElement("div");g.className="file-info";const S=document.createElement("div");if(S.className="file-name",S.textContent=o.name,g.appendChild(S),o.isFile){const f=document.createElement("div");f.className="file-meta";const T=[];o.size!==void 0&&T.push(Y(o.size)),o.mtime&&T.push(_(o.mtime)),f.textContent=T.join(" Â· "),g.appendChild(f)}if(l.appendChild(h),l.appendChild(g),o.isDir)l.addEventListener("click",()=>{const f=t==="/"?`/${o.name}`:`${t}/${o.name}`;r(f)});else if(o.isFile){const f=document.createElement("button");f.className="item-delete-btn",f.textContent="ðŸ—‘",f.addEventListener("click",async T=>{T.stopPropagation();const D=t==="/"?`/${o.name}`:`${t}/${o.name}`;if(confirm(`Delete "${o.name}"?`))try{await n.delete(D),u()}catch(I){alert(`Delete failed: ${I.message}`)}}),l.appendChild(f),l.addEventListener("click",()=>{const T=t==="/"?`/${o.name}`:`${t}/${o.name}`;c(T)})}if(o.isDir){const f=document.createElement("button");f.className="item-delete-btn",f.textContent="ðŸ—‘",f.addEventListener("click",async T=>{T.stopPropagation();const D=t==="/"?`/${o.name}`:`${t}/${o.name}`;if(confirm(`Delete folder "${o.name}" and all its contents?`))try{await n.delete(D),u()}catch(I){alert(`Delete failed: ${I.message}`)}}),l.appendChild(f)}k.appendChild(l)}e.appendChild(k);const E=document.createElement("div");E.className="actions-bar";const B=document.createElement("button");B.className="action-btn",B.textContent="+ New File",B.addEventListener("click",()=>{const o=prompt("Enter file name:");if(!o||!o.trim())return;const l=o.trim();if(l.includes("/")||l.includes("\0")){alert("File name cannot contain '/' or null characters.");return}const h=t==="/"?`/${l}`:`${t}/${l}`;c(h)});const M=document.createElement("button");M.className="action-btn",M.textContent="+ New Folder",M.addEventListener("click",async()=>{const o=prompt("Enter folder name:");if(!o||!o.trim())return;const l=o.trim();if(l.includes("/")||l.includes("\0")){alert("Folder name cannot contain '/' or null characters.");return}const h=t==="/"?`/${l}`:`${t}/${l}`;try{await n.mkdir(h),u()}catch(g){alert(`Failed to create folder: ${g.message}`)}});const x=document.createElement("button");x.className="action-btn",x.textContent="â†‘ Upload";const v=document.createElement("input");v.type="file",v.multiple=!0,v.style.display="none",x.addEventListener("click",()=>v.click()),v.addEventListener("change",async()=>{const o=v.files;if(!(!o||o.length===0)){x.disabled=!0,x.textContent="Uploading...";for(const l of Array.from(o))try{await n.upload(t,l)}catch(h){alert(`Upload failed (${l.name}): ${h.message}`)}x.disabled=!1,x.textContent="â†‘ Upload",v.value="",u()}}),E.appendChild(B),E.appendChild(M),E.appendChild(x),e.appendChild(E)}function V(s,e,t,a){if(s.innerHTML="",e.length===0){const n=document.createElement("div");n.className="status-message",n.textContent="No results found",s.appendChild(n);return}for(const n of e){const i=document.createElement("div");i.className="file-item";const r=document.createElement("span");r.className="file-icon",r.textContent=n.isDir?"ðŸ“":z(n.name);const c=document.createElement("div");c.className="file-info";const u=document.createElement("div");u.className="file-name",u.textContent=n.name,c.appendChild(u);const d=document.createElement("div");d.className="file-meta",d.textContent=n.path,c.appendChild(d),i.appendChild(r),i.appendChild(c),i.addEventListener("click",()=>{n.isDir?t(n.path):a(n.path)}),s.appendChild(i)}}async function A(s){const{container:e,client:t,dirPath:a,homeDir:n,onNavigate:i,onFileOpen:r}=s;e.innerHTML="";const c=document.createElement("div");c.className="status-message",c.textContent="Loading...",e.appendChild(c);try{const u=await t.ls(a);Q({container:e,currentPath:u.path,items:u.items,client:t,homeDir:n,onNavigate:i,onFileOpen:r,onRefresh:()=>A(s)})}catch(u){e.innerHTML="";const d=document.createElement("div");d.className="status-message error-text",d.textContent=`Failed: ${u.message}`,e.appendChild(d)}}function z(s){const e=s.toLowerCase();return e.endsWith(".md")?"ðŸ“":e.endsWith(".json")||e.endsWith(".json5")?"âš™ï¸":e.endsWith(".ts")||e.endsWith(".js")?"ðŸ“œ":e.endsWith(".sh")?"ðŸš":e.endsWith(".log")?"ðŸ“‹":e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".svg")?"ðŸ–¼ï¸":e.endsWith(".zip")||e.endsWith(".tar")||e.endsWith(".gz")?"ðŸ“¦":e.startsWith(".")?"ðŸ”§":"ðŸ“„"}function X(s){const{container:e,client:t,filePath:a,webapp:n,onBack:i}=s;e.innerHTML="";const r=document.createElement("div");r.className="editor-container";const c=document.createElement("div");c.className="editor-header";const u=document.createElement("span");u.className="editor-filename";const d=a.split("/");u.textContent=d[d.length-1]||a;const m=document.createElement("span");m.className="editor-status",m.textContent="Loading...",c.appendChild(u),c.appendChild(m);const y=document.createElement("div");y.className="file-meta",y.style.padding="0 0 8px",y.textContent=a;const p=document.createElement("textarea");p.className="editor-textarea",p.placeholder="Loading...",p.disabled=!0,p.spellcheck=!1,r.appendChild(c),r.appendChild(y),r.appendChild(p),e.appendChild(r);let $="",b=!1,L=!1,N=!1;p.addEventListener("input",()=>{if(L)return;const w=p.value!==$;w!==b&&(b=w,m.textContent=b?"Modified":N?"New file":"Saved",b?(n.MainButton.setText("Save"),n.MainButton.show()):n.MainButton.hide())}),n.BackButton.show();const C=()=>{b&&!confirm("You have unsaved changes. Discard?")||(F(),i())};n.BackButton.onClick(C);const P=async()=>{if(!L){n.MainButton.showProgress(!0),n.MainButton.disable(),m.textContent="Saving...";try{await t.write(a,p.value),$=p.value,b=!1,N=!1,m.textContent="Saved",n.MainButton.hide()}catch(w){m.textContent=`Error: ${w.message}`}finally{n.MainButton.hideProgress(),n.MainButton.enable()}}};n.MainButton.onClick(P);function F(){n.BackButton.hide(),n.BackButton.offClick(C),n.MainButton.hide(),n.MainButton.offClick(P)}k();async function k(){try{const w=await t.read(a);$=w.content,p.value=w.content,p.disabled=!1,m.textContent="Ready"}catch(w){const E=w.message;if(E.includes("binary file")){L=!0,p.style.display="none",m.textContent="";const B=document.createElement("div");B.className="binary-notice";const M=document.createElement("div");M.className="binary-icon",M.textContent="ðŸ”’";const x=document.createElement("div");x.className="binary-title",x.textContent="Binary File";const v=document.createElement("div");v.className="binary-desc",v.textContent="This file cannot be edited as text.",B.appendChild(M),B.appendChild(x),B.appendChild(v),r.appendChild(B);return}if(E.includes("ENOENT")||E.includes("no such file")){N=!0,$="",p.value="",p.disabled=!1,p.placeholder="Start typing...",m.textContent="New file",n.MainButton.setText("Save"),n.MainButton.show(),b=!0;return}m.textContent=`Error: ${E}`,p.placeholder="Failed to load file."}}}function Z(s,e){const t=W();let a="/",n="/";const r=new URLSearchParams(window.location.search).get("path");e.home().then(d=>{n=d.path,c(r||d.path)}).catch(()=>c(r||"/"));function c(d){if(a=d,t.BackButton.hide(),t.MainButton.hide(),d!=="/"&&d!==n){t.BackButton.show();const m=()=>{t.BackButton.offClick(m);const y=d.substring(0,d.lastIndexOf("/"))||"/";c(y)};t.BackButton.onClick(m)}A({container:s,client:e,dirPath:d,homeDir:n,onNavigate:m=>c(m),onFileOpen:m=>u(m)})}function u(d){X({container:s,client:e,filePath:d,webapp:t,onBack:()=>c(a)})}}async function ee(){const s=document.getElementById("app"),e=W();e.ready(),e.expand(),R(s,"Connecting...");try{const t=await ne(),a=new O(t);s.innerHTML="",Z(s,a)}catch(t){const a=t.message;if(te(a)){try{await H()}catch{}ae(s,e)}else R(s,`Connection failed: ${a}`,!0)}}function te(s){const e=s.toLowerCase();return e.includes("unauthorized")||e.includes("expired")||e.includes("no saved token")||e.includes("invalid")||e.includes("pairing")}async function ne(){const e=new URL(window.location.href).searchParams.get("pair");if(e)try{const t=await K(e);try{await J(t)}catch{}return await new O(t).home(),t}catch{}try{const t=await G();if(t&&t.length>0)return await new O(t).home(),t}catch{try{await H()}catch{}}throw new Error("No saved token. Send /files in Telegram to get started.")}function ae(s,e){s.innerHTML="";const t=document.createElement("div");t.className="status-message";const a=document.createElement("div");a.style.fontSize="48px",a.style.marginBottom="12px",a.textContent="ðŸ”‘";const n=document.createElement("div");n.style.fontWeight="600",n.style.fontSize="16px",n.style.marginBottom="8px",n.textContent="Session Expired";const i=document.createElement("div");i.style.marginBottom="16px",i.textContent="Send /files in Telegram to get a new link.";const r=document.createElement("button");r.style.cssText="padding:10px 24px;border-radius:8px;border:none;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-size:14px;font-weight:600;cursor:pointer;",r.textContent="Close",r.addEventListener("click",()=>e.close()),t.appendChild(a),t.appendChild(n),t.appendChild(i),t.appendChild(r),s.appendChild(t)}function R(s,e,t=!1){s.innerHTML="";const a=document.createElement("div");a.className=`status-message ${t?"error-text":""}`,a.textContent=e,s.appendChild(a)}ee();
