(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function o(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(t){if(t.ep)return;t.ep=!0;const n=o(t);fetch(t.href,n)}})();function w(){const s=window;if(!s.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return s.Telegram.WebApp}function y(s){const e=w();return new Promise(o=>{e.CloudStorage.getItem(s,(i,t)=>{o(i||!t?null:t)})})}function E(s,e){const o=w();return new Promise((i,t)=>{o.CloudStorage.setItem(s,e,n=>{n?t(n):i()})})}const x="gw_token",N="gw_ws_url";async function k(){const s=await y(x),e=await y(N);return s&&e?{token:s,wsUrl:e}:null}async function L(s){await E(x,s.token),await E(N,s.wsUrl)}async function M(s){const e=window.location.origin,o=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:s})});if(!o.ok){const t=await o.json().catch(()=>({}));throw new Error(t.error??"Exchange failed")}const i=await o.json();return{token:i.token,wsUrl:i.wsUrl}}const v=3;class T{constructor(e,o){this.ws=null,this.nextId=1,this.pending=new Map,this.connected=!1,this.token=e,this.wsUrl=o}connect(){return new Promise((e,o)=>{try{this.ws=new WebSocket(this.wsUrl)}catch(i){o(new Error(`WebSocket connection failed: ${i}`));return}this.ws.onopen=async()=>{try{let i=function(c){clearTimeout(r),o(c)};const t=String(this.nextId++),n=new Promise((c,a)=>{this.pending.set(t,{resolve:()=>c(),reject:d=>a(d)})});this.ws.send(JSON.stringify({type:"req",id:t,method:"connect",params:{minProtocol:v,maxProtocol:v,client:{id:"telegram-files",displayName:"Telegram File Manager",version:"0.1.0",platform:"web",mode:"webchat"},auth:{token:this.token},role:"operator",scopes:["agents.list","agents.files.list","agents.files.get","agents.files.set"],caps:[]}}));const r=setTimeout(()=>{this.pending.has(t)&&(this.pending.delete(t),i(new Error("Connect timeout")))},1e4);await n,clearTimeout(r),this.connected=!0,e()}catch(i){o(i instanceof Error?i:new Error(String(i)))}},this.ws.onmessage=i=>{try{const t=JSON.parse(i.data);if(t.type==="res"&&t.id&&this.pending.has(t.id)){const n=this.pending.get(t.id);this.pending.delete(t.id),t.ok===!1||t.error?n.reject(new Error(t.error?.message??"Request failed")):n.resolve(t.result)}}catch{}},this.ws.onerror=()=>{this.connected||o(new Error("WebSocket error"))},this.ws.onclose=i=>{this.connected=!1;const t=i.reason||`code ${i.code}`;for(const[,n]of this.pending)n.reject(new Error(`Connection closed: ${t}`));this.pending.clear()}})}call(e,o){return new Promise((i,t)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){t(new Error("Not connected"));return}const n=String(this.nextId++);this.pending.set(n,{resolve:i,reject:t}),this.ws.send(JSON.stringify({type:"req",id:n,method:e,params:o})),setTimeout(()=>{this.pending.has(n)&&(this.pending.delete(n),t(new Error("RPC timeout")))},15e3)})}async listFiles(e){return(await this.call("agents.files.list",{agentId:e}))?.files??[]}async getFile(e,o){return(await this.call("agents.files.get",{agentId:e,name:o}))?.content??""}async setFile(e,o,i){await this.call("agents.files.set",{agentId:e,name:o,content:i})}async listAgents(){return(await this.call("agents.list",{}))?.agents??[]}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1}get isConnected(){return this.connected}}function b(s){const{container:e,files:o,agentId:i,onFileClick:t}=s;e.innerHTML="";const n=document.createElement("h1");n.className="page-header",n.textContent="Files",e.appendChild(n);const r=document.createElement("div");if(r.className="file-meta",r.style.paddingBottom="8px",r.textContent=`Agent: ${i}`,e.appendChild(r),o.length===0){const a=document.createElement("div");a.className="status-message",a.innerHTML='<span class="emoji">ğŸ“‚</span>No files found for this agent.',e.appendChild(a);return}const c=document.createElement("div");c.className="file-list";for(const a of o){const d=document.createElement("div");d.className="file-item",d.addEventListener("click",()=>t(a.name));const u=document.createElement("span");u.className="file-icon",u.textContent=P(a.name);const l=document.createElement("div");l.className="file-info";const h=document.createElement("div");h.className="file-name",h.textContent=a.name;const f=document.createElement("div");f.className="file-meta",f.textContent=a.sizeBytes!=null?I(a.sizeBytes):"",l.appendChild(h),l.appendChild(f);const p=document.createElement("span");p.className=`file-badge ${a.exists?"exists":"missing"}`,p.textContent=a.exists?"exists":"create",d.appendChild(u),d.appendChild(l),d.appendChild(p),c.appendChild(d)}e.appendChild(c)}async function F(s){const{container:e,client:o,agentId:i,onFileClick:t}=s;e.innerHTML='<div class="status-message">Loading files...</div>';try{const n=await o.listFiles(i);b({container:e,files:n,agentId:i,onFileClick:t})}catch(n){e.innerHTML=`<div class="status-message error-text">Failed to load files: ${n.message}</div>`}}function P(s){const e=s.toLowerCase();return e.endsWith(".md")?"ğŸ“":e.includes("soul")?"ğŸ§ ":e.includes("tool")?"ğŸ”§":e.includes("config")?"âš™ï¸":e.includes("memory")?"ğŸ’¾":"ğŸ“„"}function I(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`}function O(s){const{container:e,client:o,agentId:i,fileName:t,webapp:n,onBack:r}=s;e.innerHTML="";const c=document.createElement("div");c.className="editor-container";const a=document.createElement("div");a.className="editor-header";const d=document.createElement("span");d.className="editor-filename",d.textContent=t;const u=document.createElement("span");u.className="editor-status",u.textContent="Loading...",a.appendChild(d),a.appendChild(u);const l=document.createElement("textarea");l.className="editor-textarea",l.placeholder="Loading file content...",l.disabled=!0,l.spellcheck=!1,c.appendChild(a),c.appendChild(l),e.appendChild(c);let h="",f=!1;l.addEventListener("input",()=>{const m=l.value!==h;m!==f&&(f=m,u.textContent=f?"Modified":"Saved",f?(n.MainButton.setText("Save"),n.MainButton.show()):n.MainButton.hide())}),n.BackButton.show();const p=()=>{f&&!confirm("You have unsaved changes. Discard?")||(B(),r())};n.BackButton.onClick(p);const C=async()=>{n.MainButton.showProgress(!0),n.MainButton.disable(),u.textContent="Saving...";try{await o.setFile(i,t,l.value),h=l.value,f=!1,u.textContent="Saved",n.MainButton.hide()}catch(m){u.textContent=`Error: ${m.message}`}finally{n.MainButton.hideProgress(),n.MainButton.enable()}};n.MainButton.onClick(C);function B(){n.BackButton.hide(),n.BackButton.offClick(p),n.MainButton.hide(),n.MainButton.offClick(C)}S();async function S(){try{const m=await o.getFile(i,t);h=m,l.value=m,l.disabled=!1,u.textContent=m?"Ready":"New file"}catch(m){u.textContent=`Error: ${m.message}`,l.placeholder="Failed to load file content."}}}async function $(s,e){const o=w();if(e.agents.length>1){const r=document.createElement("div");r.className="agent-selector";for(const c of e.agents){const a=document.createElement("button");a.className=`agent-chip ${c.id===e.agentId?"active":""}`,a.textContent=c.name??c.id,a.addEventListener("click",()=>{e.agentId=c.id,r.querySelectorAll(".agent-chip").forEach(d=>d.classList.remove("active")),a.classList.add("active"),t()}),r.appendChild(a)}s.appendChild(r)}const i=document.createElement("div");i.style.flex="1",i.style.display="flex",i.style.flexDirection="column",s.appendChild(i),t();function t(){o.BackButton.hide(),o.MainButton.hide(),F({container:i,client:e.client,agentId:e.agentId,onFileClick:r=>n(r)})}function n(r){O({container:i,client:e.client,agentId:e.agentId,fileName:r,webapp:o,onBack:()=>t()})}}async function A(){const s=document.getElementById("app"),e=w();e.ready(),e.expand(),g(s,"Connecting...");try{const o=await W();g(s,"Connecting to gateway...");const i=new T(o.token,o.wsUrl);await i.connect();const t=await i.listAgents();if(t.length===0){g(s,"No agents found. Create an agent first.",!0);return}s.innerHTML="",await $(s,{client:i,agentId:t[0].id,agents:t})}catch(o){g(s,`Connection failed: ${o.message}`,!0)}}async function W(){const s=await k();if(s)return s;const e=new URL(window.location.href),o=e.searchParams.get("pair");if(!o)throw new Error("No saved token and no pairing code. Send /files in Telegram to get started.");const i=await M(o);return await L(i),e.searchParams.delete("pair"),window.history.replaceState({},"",e.toString()),i}function g(s,e,o=!1){s.innerHTML=`<div class="status-message ${o?"error-text":""}">${H(e)}</div>`}function H(s){const e=document.createElement("div");return e.textContent=s,e.innerHTML}A();
