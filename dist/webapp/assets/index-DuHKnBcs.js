(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function P(){const i=window;if(!i.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return i.Telegram.WebApp}function R(i){const e=P();return new Promise(t=>{e.CloudStorage.getItem(i,(a,n)=>{t(a||!n?null:n)})})}function O(i,e){const t=P();return new Promise((a,n)=>{t.CloudStorage.setItem(i,e,s=>{s?n(s):a()})})}const I="fs_token";async function A(){return await R(I)}async function q(i){await O(I,i)}async function z(){await O(I,"")}async function G(i){const e=window.location.origin,t=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:i})});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.error??"Exchange failed")}return(await t.json()).token}class j{constructor(e){this.token=e,this.baseUrl=`${window.location.origin}/plugins/telegram-files/api`}async request(e,t,a){const n={Authorization:`Bearer ${this.token}`},s={method:e,headers:n};a!==void 0&&(n["Content-Type"]="application/json",s.body=JSON.stringify(a));const r=await fetch(`${this.baseUrl}${t}`,s);let c;if((r.headers.get("content-type")??"").includes("application/json")?c=await r.json():c={error:await r.text()||`HTTP ${r.status}`},!r.ok)throw new Error(c.error??`HTTP ${r.status}`);return c}async ls(e){const t=encodeURIComponent(e);return await this.request("GET",`/ls?path=${t}`)}async read(e){const t=encodeURIComponent(e);return await this.request("GET",`/read?path=${t}`)}async write(e,t){await this.request("POST","/write",{path:e,content:t})}async delete(e){const t=encodeURIComponent(e);await this.request("DELETE",`/delete?path=${t}`)}async mkdir(e){await this.request("POST","/mkdir",{path:e})}async home(){return await this.request("GET","/home")}async upload(e,t){const a=encodeURIComponent(e),n=encodeURIComponent(t.name),s=await fetch(`${this.baseUrl}/upload?dir=${a}&name=${n}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:t});let r;if((s.headers.get("content-type")??"").includes("application/json")?r=await s.json():r={error:await s.text()||`HTTP ${s.status}`},!s.ok)throw new Error(r.error??`HTTP ${s.status}`)}async search(e,t){const a=encodeURIComponent(e),n=encodeURIComponent(t);return await this.request("GET",`/search?path=${a}&q=${n}`)}}function J(i){if(i<=0)return"0 B";const e=["B","KB","MB","GB"],t=Math.min(Math.floor(Math.log(i)/Math.log(1024)),e.length-1),a=i/Math.pow(1024,t);return`${a<10?a.toFixed(1):Math.round(a)} ${e[t]}`}function K(i){if(!i)return"";const e=Date.now()-i,t=Math.floor(e/1e3);if(t<60)return"just now";const a=Math.floor(t/60);if(a<60)return`${a}m ago`;const n=Math.floor(a/60);if(n<24)return`${n}h ago`;const s=Math.floor(n/24);if(s<7)return`${s}d ago`;const r=new Date(i);return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][r.getMonth()]} ${r.getDate()}`}function Y(i){const{container:e,currentPath:t,items:a,client:n,onNavigate:s,onFileOpen:r,onRefresh:c}=i;e.innerHTML="";const d=document.createElement("div");d.className="list-toolbar";const h=document.createElement("div");h.className="path-header";const p=t.split("/").filter(Boolean);for(let o=0;o<p.length;o++){if(o>0){const E=document.createElement("span");E.className="breadcrumb-sep",E.textContent=" / ",h.appendChild(E)}const l="/"+p.slice(0,o+1).join("/"),u=document.createElement("span");u.className="breadcrumb-link",u.textContent=p[o],o<p.length-1?u.addEventListener("click",()=>s(l)):u.className="breadcrumb-current",h.appendChild(u)}p.length===0&&(h.textContent="/");const v=document.createElement("button");v.className="toggle-hidden-btn";const m=localStorage.getItem("tgfiles-show-hidden")==="1";v.textContent=m?"Hide .*":"Show .*",v.addEventListener("click",()=>{const o=localStorage.getItem("tgfiles-show-hidden")==="1"?"0":"1";localStorage.setItem("tgfiles-show-hidden",o),c()}),d.appendChild(h),d.appendChild(v),e.appendChild(d);const T=document.createElement("div");T.className="search-bar";const g=document.createElement("input");g.type="text",g.placeholder="Search files...",g.className="search-input",T.appendChild(g),e.appendChild(T);const C=document.createElement("div");C.className="search-results",C.style.display="none",e.appendChild(C);let k=null,L=0;g.addEventListener("input",()=>{k&&clearTimeout(k);const o=g.value.trim();if(!o){C.style.display="none",N.style.display="",b.style.display="";return}k=setTimeout(async()=>{const l=++L;C.innerHTML="";const u=document.createElement("div");u.className="status-message",u.textContent="Searching...",C.appendChild(u),C.style.display="",N.style.display="none",b.style.display="none";try{const E=await n.search(t,o);if(l!==L)return;_(C,E.results,s,r)}catch(E){if(l!==L)return;C.innerHTML="";const M=document.createElement("div");M.className="status-message error-text",M.textContent=`Search failed: ${E.message}`,C.appendChild(M)}},300)});const N=document.createElement("div");N.className="file-list";const S=m?a:a.filter(o=>!o.name.startsWith("."));if(S.length===0){const o=document.createElement("div");o.className="status-message",o.textContent="Empty directory",N.appendChild(o)}else for(const o of S){const l=document.createElement("div");l.className="file-item";const u=document.createElement("span");u.className="file-icon",u.textContent=o.isDir?"ðŸ“":o.isSymlink?"ðŸ”—":U(o.name);const E=document.createElement("div");E.className="file-info";const M=document.createElement("div");if(M.className="file-name",M.textContent=o.name,E.appendChild(M),o.isFile){const f=document.createElement("div");f.className="file-meta";const $=[];o.size!==void 0&&$.push(J(o.size)),o.mtime&&$.push(K(o.mtime)),f.textContent=$.join(" Â· "),E.appendChild(f)}if(l.appendChild(u),l.appendChild(E),o.isDir)l.addEventListener("click",()=>{const f=t==="/"?`/${o.name}`:`${t}/${o.name}`;s(f)});else if(o.isFile){const f=document.createElement("button");f.className="item-delete-btn",f.textContent="ðŸ—‘",f.addEventListener("click",async $=>{$.stopPropagation();const F=t==="/"?`/${o.name}`:`${t}/${o.name}`;if(confirm(`Delete "${o.name}"?`))try{await n.delete(F),c()}catch(W){alert(`Delete failed: ${W.message}`)}}),l.appendChild(f),l.addEventListener("click",()=>{const $=t==="/"?`/${o.name}`:`${t}/${o.name}`;r($)})}if(o.isDir){const f=document.createElement("button");f.className="item-delete-btn",f.textContent="ðŸ—‘",f.addEventListener("click",async $=>{$.stopPropagation();const F=t==="/"?`/${o.name}`:`${t}/${o.name}`;if(confirm(`Delete folder "${o.name}" and all its contents?`))try{await n.delete(F),c()}catch(W){alert(`Delete failed: ${W.message}`)}}),l.appendChild(f)}N.appendChild(l)}e.appendChild(N);const b=document.createElement("div");b.className="actions-bar";const y=document.createElement("button");y.className="action-btn",y.textContent="+ New File",y.addEventListener("click",()=>{const o=prompt("Enter file name:");if(!o||!o.trim())return;const l=o.trim();if(l.includes("/")||l.includes("\0")){alert("File name cannot contain '/' or null characters.");return}const u=t==="/"?`/${l}`:`${t}/${l}`;r(u)});const B=document.createElement("button");B.className="action-btn",B.textContent="+ New Folder",B.addEventListener("click",async()=>{const o=prompt("Enter folder name:");if(!o||!o.trim())return;const l=o.trim();if(l.includes("/")||l.includes("\0")){alert("Folder name cannot contain '/' or null characters.");return}const u=t==="/"?`/${l}`:`${t}/${l}`;try{await n.mkdir(u),c()}catch(E){alert(`Failed to create folder: ${E.message}`)}});const w=document.createElement("button");w.className="action-btn",w.textContent="â†‘ Upload";const x=document.createElement("input");x.type="file",x.multiple=!0,x.style.display="none",w.addEventListener("click",()=>x.click()),x.addEventListener("change",async()=>{const o=x.files;if(!(!o||o.length===0)){w.disabled=!0,w.textContent="Uploading...";for(const l of Array.from(o))try{await n.upload(t,l)}catch(u){alert(`Upload failed (${l.name}): ${u.message}`)}w.disabled=!1,w.textContent="â†‘ Upload",x.value="",c()}}),b.appendChild(y),b.appendChild(B),b.appendChild(w),e.appendChild(b)}function _(i,e,t,a){if(i.innerHTML="",e.length===0){const n=document.createElement("div");n.className="status-message",n.textContent="No results found",i.appendChild(n);return}for(const n of e){const s=document.createElement("div");s.className="file-item";const r=document.createElement("span");r.className="file-icon",r.textContent=n.isDir?"ðŸ“":U(n.name);const c=document.createElement("div");c.className="file-info";const d=document.createElement("div");d.className="file-name",d.textContent=n.name,c.appendChild(d);const h=document.createElement("div");h.className="file-meta",h.textContent=n.path,c.appendChild(h),s.appendChild(r),s.appendChild(c),s.addEventListener("click",()=>{n.isDir?t(n.path):a(n.path)}),i.appendChild(s)}}async function H(i){const{container:e,client:t,dirPath:a,onNavigate:n,onFileOpen:s}=i;e.innerHTML="";const r=document.createElement("div");r.className="status-message",r.textContent="Loading...",e.appendChild(r);try{const c=await t.ls(a);Y({container:e,currentPath:c.path,items:c.items,client:t,onNavigate:n,onFileOpen:s,onRefresh:()=>H(i)})}catch(c){e.innerHTML="";const d=document.createElement("div");d.className="status-message error-text",d.textContent=`Failed: ${c.message}`,e.appendChild(d)}}function U(i){const e=i.toLowerCase();return e.endsWith(".md")?"ðŸ“":e.endsWith(".json")||e.endsWith(".json5")?"âš™ï¸":e.endsWith(".ts")||e.endsWith(".js")?"ðŸ“œ":e.endsWith(".sh")?"ðŸš":e.endsWith(".log")?"ðŸ“‹":e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".svg")?"ðŸ–¼ï¸":e.endsWith(".zip")||e.endsWith(".tar")||e.endsWith(".gz")?"ðŸ“¦":e.startsWith(".")?"ðŸ”§":"ðŸ“„"}function Q(i){const{container:e,client:t,filePath:a,webapp:n,onBack:s}=i;e.innerHTML="";const r=document.createElement("div");r.className="editor-container";const c=document.createElement("div");c.className="editor-header";const d=document.createElement("span");d.className="editor-filename";const h=a.split("/");d.textContent=h[h.length-1]||a;const p=document.createElement("span");p.className="editor-status",p.textContent="Loading...",c.appendChild(d),c.appendChild(p);const v=document.createElement("div");v.className="file-meta",v.style.padding="0 0 8px",v.textContent=a;const m=document.createElement("textarea");m.className="editor-textarea",m.placeholder="Loading...",m.disabled=!0,m.spellcheck=!1,r.appendChild(c),r.appendChild(v),r.appendChild(m),e.appendChild(r);let T="",g=!1,C=!1,k=!1;m.addEventListener("input",()=>{if(C)return;const y=m.value!==T;y!==g&&(g=y,p.textContent=g?"Modified":k?"New file":"Saved",g?(n.MainButton.setText("Save"),n.MainButton.show()):n.MainButton.hide())}),n.BackButton.show();const L=()=>{g&&!confirm("You have unsaved changes. Discard?")||(S(),s())};n.BackButton.onClick(L);const N=async()=>{if(!C){n.MainButton.showProgress(!0),n.MainButton.disable(),p.textContent="Saving...";try{await t.write(a,m.value),T=m.value,g=!1,k=!1,p.textContent="Saved",n.MainButton.hide()}catch(y){p.textContent=`Error: ${y.message}`}finally{n.MainButton.hideProgress(),n.MainButton.enable()}}};n.MainButton.onClick(N);function S(){n.BackButton.hide(),n.BackButton.offClick(L),n.MainButton.hide(),n.MainButton.offClick(N)}b();async function b(){try{const y=await t.read(a);T=y.content,m.value=y.content,m.disabled=!1,p.textContent="Ready"}catch(y){const B=y.message;if(B.includes("binary file")){C=!0,m.style.display="none",p.textContent="";const w=document.createElement("div");w.className="binary-notice";const x=document.createElement("div");x.className="binary-icon",x.textContent="ðŸ”’";const o=document.createElement("div");o.className="binary-title",o.textContent="Binary File";const l=document.createElement("div");l.className="binary-desc",l.textContent="This file cannot be edited as text.",w.appendChild(x),w.appendChild(o),w.appendChild(l),r.appendChild(w);return}if(B.includes("ENOENT")||B.includes("no such file")){k=!0,T="",m.value="",m.disabled=!1,m.placeholder="Start typing...",p.textContent="New file",n.MainButton.setText("Save"),n.MainButton.show(),g=!0;return}p.textContent=`Error: ${B}`,m.placeholder="Failed to load file."}}}function V(i,e){const t=P();let a="/",n="/";e.home().then(c=>{n=c.path,s(c.path)}).catch(()=>s("/"));function s(c){if(a=c,t.BackButton.hide(),t.MainButton.hide(),c!=="/"&&c!==n){t.BackButton.show();const d=()=>{t.BackButton.offClick(d);const h=c.substring(0,c.lastIndexOf("/"))||"/";s(h)};t.BackButton.onClick(d)}H({container:i,client:e,dirPath:c,onNavigate:d=>s(d),onFileOpen:d=>r(d)})}function r(c){Q({container:i,client:e,filePath:c,webapp:t,onBack:()=>s(a)})}}async function X(){const i=document.getElementById("app"),e=P();e.ready(),e.expand(),D(i,"Connecting...");try{const t=await Z();D(i,"Loading...");const a=new j(t);await a.home(),i.innerHTML="",V(i,a)}catch(t){const a=t.message;a.includes("No saved token")||a.includes("unauthorized")||a.includes("expired")?ee(i,e):D(i,`Connection failed: ${a}`,!0)}}async function Z(){const e=new URL(window.location.href).searchParams.get("pair");if(e)try{const t=await G(e);try{await q(t)}catch{}return t}catch{}try{const t=await A();if(t){const a=new j(t);try{return await a.home(),t}catch{try{await z()}catch{}}}}catch{}throw new Error("No saved token. Send /files in Telegram to get started.")}function ee(i,e){i.innerHTML="";const t=document.createElement("div");t.className="status-message";const a=document.createElement("div");a.style.fontSize="48px",a.style.marginBottom="12px",a.textContent="ðŸ”‘";const n=document.createElement("div");n.style.fontWeight="600",n.style.fontSize="16px",n.style.marginBottom="8px",n.textContent="Session Expired";const s=document.createElement("div");s.style.marginBottom="16px",s.textContent="Send /files in Telegram to get a new link.";const r=document.createElement("button");r.style.cssText="padding:10px 24px;border-radius:8px;border:none;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-size:14px;font-weight:600;cursor:pointer;",r.textContent="Close",r.addEventListener("click",()=>e.close()),t.appendChild(a),t.appendChild(n),t.appendChild(s),t.appendChild(r),i.appendChild(t)}function D(i,e,t=!1){i.innerHTML="";const a=document.createElement("div");a.className=`status-message ${t?"error-text":""}`,a.textContent=e,i.appendChild(a)}X();
