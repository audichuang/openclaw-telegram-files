(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(t){if(t.ep)return;t.ep=!0;const i=n(t);fetch(t.href,i)}})();function F(){const a=window;if(!a.Telegram?.WebApp)throw new Error("Telegram WebApp SDK not available");return a.Telegram.WebApp}function Y(a){const e=F();return new Promise(n=>{e.CloudStorage.getItem(a,(o,t)=>{n(o||!t?null:t)})})}function H(a,e){const n=F();return new Promise((o,t)=>{n.CloudStorage.setItem(a,e,i=>{i?t(i):o()})})}const A="fs_token";async function Q(){return await Y(A)}async function X(a){await H(A,a)}async function J(){await H(A,"")}async function V(a){const e=window.location.origin,n=await fetch(`${e}/plugins/telegram-files/api/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairCode:a})});let o;if((n.headers.get("content-type")??"").includes("application/json")?o=await n.json():o={error:await n.text()||`HTTP ${n.status}`},!n.ok||!o||typeof o!="object"||!("token"in o))throw new Error(o?.error??"Exchange failed");return o.token}class R{constructor(e){this.token=e,this.baseUrl=`${window.location.origin}/plugins/telegram-files/api`}async request(e,n,o){const t={Authorization:`Bearer ${this.token}`},i={method:e,headers:t};o!==void 0&&(t["Content-Type"]="application/json",i.body=JSON.stringify(o));const r=await fetch(`${this.baseUrl}${n}`,i);let d;if((r.headers.get("content-type")??"").includes("application/json")?d=await r.json():d={error:await r.text()||`HTTP ${r.status}`},!r.ok)throw new Error(d.error??`HTTP ${r.status}`);return d}async ls(e){const n=encodeURIComponent(e);return await this.request("GET",`/ls?path=${n}`)}async read(e){const n=encodeURIComponent(e);return await this.request("GET",`/read?path=${n}`)}async write(e,n){await this.request("POST","/write",{path:e,content:n})}async delete(e){const n=encodeURIComponent(e);await this.request("DELETE",`/delete?path=${n}`)}async mkdir(e){await this.request("POST","/mkdir",{path:e})}async home(){return await this.request("GET","/home")}async upload(e,n){const o=encodeURIComponent(e),t=encodeURIComponent(n.name),i=await fetch(`${this.baseUrl}/upload?dir=${o}&name=${t}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:n});let r;if((i.headers.get("content-type")??"").includes("application/json")?r=await i.json():r={error:await i.text()||`HTTP ${i.status}`},!i.ok)throw new Error(r.error??`HTTP ${i.status}`)}async search(e,n){const o=encodeURIComponent(e),t=encodeURIComponent(n);return await this.request("GET",`/search?path=${o}&q=${t}`)}}function L(a){return a instanceof Error?a.message:String(a)}function O(a,e){return a.endsWith("/")?`${a}${e}`:`${a}/${e}`}function Z(a){if(a<=0)return"0 B";const e=["B","KB","MB","GB"],n=Math.min(Math.floor(Math.log(a)/Math.log(1024)),e.length-1),o=a/Math.pow(1024,n);return`${o<10?o.toFixed(1):Math.round(o)} ${e[n]}`}function ee(a){if(!a)return"";const e=Date.now()-a,n=Math.floor(e/1e3);if(n<60)return"just now";const o=Math.floor(n/60);if(o<60)return`${o}m ago`;const t=Math.floor(o/60);if(t<24)return`${t}h ago`;const i=Math.floor(t/24);if(i<7)return`${i}d ago`;const r=new Date(a);return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][r.getMonth()]} ${r.getDate()}`}function q(a,e,n,o,t){const i=document.createElement("button");return i.className="item-delete-btn",i.textContent="ðŸ—‘",i.addEventListener("click",async r=>{if(r.stopPropagation(),i.disabled)return;const d=n?`Delete folder "${e}" and all its contents?`:`Delete "${e}"?`;if(confirm(d)){i.disabled=!0;try{await o.delete(a),t()}catch(u){i.disabled=!1,alert(`Delete failed: ${L(u)}`)}}}),i}const U=500;function te(a){const{container:e,currentPath:n,items:o,client:t,homeDir:i,onNavigate:r,onFileOpen:d,onRefresh:u}=a;e.replaceChildren();const p=document.createElement("div");p.className="list-toolbar";const c=document.createElement("div");c.className="path-header";const h=n.split("/").filter(Boolean);for(let s=0;s<h.length;s++){if(s>0){const E=document.createElement("span");E.className="breadcrumb-sep",E.textContent=" / ",c.appendChild(E)}const l="/"+h.slice(0,s+1).join("/"),f=document.createElement("span");f.textContent=h[s],s===h.length-1?f.className="breadcrumb-current":l.length>=i.length&&l.startsWith(i)?(f.className="breadcrumb-link",f.addEventListener("click",()=>r(l))):f.className="breadcrumb-disabled",c.appendChild(f)}h.length===0&&(c.textContent="/");const m=document.createElement("button");m.className="toggle-hidden-btn";const k=localStorage.getItem("tgfiles-show-hidden")==="1";m.textContent=k?"Hide .*":"Show .*",m.addEventListener("click",()=>{const s=localStorage.getItem("tgfiles-show-hidden")==="1"?"0":"1";localStorage.setItem("tgfiles-show-hidden",s),u()}),p.appendChild(c),p.appendChild(m),e.appendChild(p);const x=document.createElement("div");x.className="search-bar";const N=document.createElement("input");N.type="text",N.placeholder="Search files...",N.className="search-input",x.appendChild(N),e.appendChild(x);const C=document.createElement("div");C.className="search-results",C.style.display="none",e.appendChild(C);let T=null,$=0;N.addEventListener("input",()=>{T&&clearTimeout(T);const s=N.value.trim();if(!s){C.style.display="none",b.style.display="",g.style.display="";return}T=setTimeout(async()=>{const l=++$;C.replaceChildren();const f=document.createElement("div");f.className="status-message",f.textContent="Searching...",C.appendChild(f),C.style.display="",b.style.display="none",g.style.display="none";try{const E=await t.search(n,s);if(l!==$)return;ne(C,E.results,r,d)}catch(E){if(l!==$)return;C.replaceChildren();const S=document.createElement("div");S.className="status-message error-text",S.textContent=`Search failed: ${L(E)}`,C.appendChild(S)}},300)});const b=document.createElement("div");b.className="file-list";const M=k?o:o.filter(s=>!s.name.startsWith(".")),P=M.slice(0,U);if(P.length===0){const s=document.createElement("div");s.className="status-message",s.textContent="Empty directory",b.appendChild(s)}else for(const s of P){const l=document.createElement("div");l.className="file-item";const f=document.createElement("span");f.className="file-icon",f.textContent=s.isDir?"ðŸ“":s.isSymlink?"ðŸ”—":_(s.name);const E=document.createElement("div");E.className="file-info";const S=document.createElement("div");if(S.className="file-name",S.textContent=s.name,E.appendChild(S),s.isFile){const W=document.createElement("div");W.className="file-meta";const D=[];s.size!==void 0&&D.push(Z(s.size)),s.mtime&&D.push(ee(s.mtime)),W.textContent=D.join(" Â· "),E.appendChild(W)}l.appendChild(f),l.appendChild(E);const I=O(n,s.name);s.isDir?(l.addEventListener("click",()=>r(I)),l.appendChild(q(I,s.name,!0,t,u))):s.isFile&&(l.appendChild(q(I,s.name,!1,t,u)),l.addEventListener("click",()=>d(I))),b.appendChild(l)}if(M.length>U){const s=document.createElement("div");s.className="status-message",s.textContent=`Showing ${U} of ${M.length} items. Use search to find specific files.`,b.appendChild(s)}e.appendChild(b);const g=document.createElement("div");g.className="actions-bar";const B=document.createElement("button");B.className="action-btn",B.textContent="+ New File",B.addEventListener("click",()=>{const s=prompt("Enter file name:");if(!s||!s.trim())return;const l=s.trim();if(l.includes("/")||l.includes("\\")||l.includes("\0")||l===".."||l==="."){alert("Invalid file name.");return}d(O(n,l))});const y=document.createElement("button");y.className="action-btn",y.textContent="+ New Folder",y.addEventListener("click",async()=>{const s=prompt("Enter folder name:");if(!s||!s.trim())return;const l=s.trim();if(l.includes("/")||l.includes("\\")||l.includes("\0")||l===".."||l==="."){alert("Invalid folder name.");return}y.disabled=!0,y.textContent="Creating...";try{await t.mkdir(O(n,l)),u()}catch(f){y.disabled=!1,y.textContent="+ New Folder",alert(`Failed to create folder: ${L(f)}`)}});const w=document.createElement("button");w.className="action-btn",w.textContent="â†‘ Upload";const v=document.createElement("input");v.type="file",v.multiple=!0,v.style.display="none",w.addEventListener("click",()=>v.click()),v.addEventListener("change",async()=>{const s=v.files;if(!(!s||s.length===0)){w.disabled=!0,w.textContent="Uploading...";for(const l of Array.from(s))try{await t.upload(n,l)}catch(f){alert(`Upload failed (${l.name}): ${L(f)}`)}w.disabled=!1,w.textContent="â†‘ Upload",v.value="",u()}}),g.appendChild(B),g.appendChild(y),g.appendChild(w),e.appendChild(g)}function ne(a,e,n,o){if(a.replaceChildren(),e.length===0){const t=document.createElement("div");t.className="status-message",t.textContent="No results found",a.appendChild(t);return}for(const t of e){const i=document.createElement("div");i.className="file-item";const r=document.createElement("span");r.className="file-icon",r.textContent=t.isDir?"ðŸ“":_(t.name);const d=document.createElement("div");d.className="file-info";const u=document.createElement("div");u.className="file-name",u.textContent=t.name,d.appendChild(u);const p=document.createElement("div");p.className="file-meta",p.textContent=t.path,d.appendChild(p),i.appendChild(r),i.appendChild(d),i.addEventListener("click",()=>{t.isDir?n(t.path):o(t.path)}),a.appendChild(i)}}let j=0;async function K(a){const e=++j,{container:n,client:o,dirPath:t,homeDir:i,onNavigate:r,onFileOpen:d}=a;n.replaceChildren();const u=document.createElement("div");u.className="status-message",u.textContent="Loading...",n.appendChild(u);try{const p=await o.ls(t);if(e!==j)return;te({container:n,currentPath:p.path,items:p.items,client:o,homeDir:i,onNavigate:r,onFileOpen:d,onRefresh:()=>K(a)})}catch(p){if(e!==j)return;n.replaceChildren();const c=document.createElement("div");c.className="status-message error-text",c.textContent=`Failed: ${L(p)}`,n.appendChild(c)}}function _(a){const e=a.toLowerCase();return e.endsWith(".md")?"ðŸ“":e.endsWith(".json")||e.endsWith(".json5")?"âš™ï¸":e.endsWith(".ts")||e.endsWith(".js")?"ðŸ“œ":e.endsWith(".sh")?"ðŸš":e.endsWith(".log")?"ðŸ“‹":e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")||e.endsWith(".svg")?"ðŸ–¼ï¸":e.endsWith(".zip")||e.endsWith(".tar")||e.endsWith(".gz")?"ðŸ“¦":e.startsWith(".")?"ðŸ”§":"ðŸ“„"}function z(a){return a instanceof Error?a.message:String(a)}function ae(a){const{container:e,client:n,filePath:o,webapp:t,onBack:i}=a;e.replaceChildren();const r=document.createElement("div");r.className="editor-container";const d=document.createElement("div");d.className="editor-header";const u=document.createElement("span");u.className="editor-filename";const p=o.split("/");u.textContent=p[p.length-1]||o;const c=document.createElement("span");c.className="editor-status",c.textContent="Loading...",d.appendChild(u),d.appendChild(c);const h=document.createElement("div");h.className="file-meta",h.style.padding="0 0 8px",h.textContent=o;const m=document.createElement("textarea");m.className="editor-textarea",m.placeholder="Loading...",m.disabled=!0,m.spellcheck=!1,r.appendChild(d),r.appendChild(h),r.appendChild(m),e.appendChild(r);let k="",x=!1,N=!1,C=!1,T=!1;m.addEventListener("input",()=>{if(N)return;const g=m.value!==k;g!==x&&(x=g,c.textContent=x?"Modified":C?"New file":"Saved",x?(t.MainButton.setText("Save"),t.MainButton.show()):t.MainButton.hide())}),t.BackButton.show();const $=()=>{x&&!confirm("You have unsaved changes. Discard?")||(M(),i())};t.BackButton.onClick($);const b=async()=>{if(!(N||T)){T=!0,t.MainButton.showProgress(!0),t.MainButton.disable(),c.textContent="Saving...";try{await n.write(o,m.value),k=m.value,x=!1,C=!1,c.textContent="Saved",t.MainButton.hide()}catch(g){c.textContent=`Error: ${z(g)}`}finally{T=!1,t.MainButton.hideProgress(),t.MainButton.enable()}}};t.MainButton.onClick(b);function M(){t.BackButton.hide(),t.BackButton.offClick($),t.MainButton.hide(),t.MainButton.offClick(b)}P();async function P(){try{const g=await n.read(o);k=g.content,m.value=g.content,m.disabled=!1,c.textContent="Ready"}catch(g){const B=z(g);if(B.includes("binary file")){N=!0,m.style.display="none",c.textContent="";const y=document.createElement("div");y.className="binary-notice";const w=document.createElement("div");w.className="binary-icon",w.textContent="ðŸ”’";const v=document.createElement("div");v.className="binary-title",v.textContent="Binary File";const s=document.createElement("div");s.className="binary-desc",s.textContent="This file cannot be edited as text.",y.appendChild(w),y.appendChild(v),y.appendChild(s),r.appendChild(y);return}if(B.includes("ENOENT")||B.includes("no such file")){C=!0,k="",m.value="",m.disabled=!1,m.placeholder="Start typing...",c.textContent="New file",t.MainButton.setText("Save"),t.MainButton.show(),x=!0;return}c.textContent=`Error: ${B}`,m.placeholder="Failed to load file."}}}function oe(a,e){const n=F();let o="/",t="/",i=null;const d=new URLSearchParams(window.location.search).get("path");e.home().then(c=>{t=c.path,u(d||c.path)}).catch(()=>u(d||"/"));function u(c){if(o=c,i&&(n.BackButton.offClick(i),i=null),n.BackButton.hide(),n.MainButton.hide(),c!=="/"&&c!==t){n.BackButton.show();const h=()=>{n.BackButton.offClick(h),i=null;const m=c.substring(0,c.lastIndexOf("/"))||"/";u(m)};i=h,n.BackButton.onClick(h)}K({container:a,client:e,dirPath:c,homeDir:t,onNavigate:h=>u(h),onFileOpen:h=>p(h)})}function p(c){i&&(n.BackButton.offClick(i),i=null),ae({container:a,client:e,filePath:c,webapp:n,onBack:()=>u(o)})}}function ie(a){return a instanceof Error?a.message:String(a)}async function se(){const a=document.getElementById("app");if(!a){document.body.textContent="Fatal: #app element not found";return}const e=F();e.ready(),e.expand(),G(a,"Connecting...");try{const n=await ce(),o=new R(n),t=new URL(window.location.href);t.searchParams.has("pair")&&(t.searchParams.delete("pair"),history.replaceState(null,"",t.toString())),a.replaceChildren(),oe(a,o)}catch(n){const o=ie(n);if(re(o)){try{await J()}catch{}le(a,e)}else G(a,`Connection failed: ${o}`,!0)}}function re(a){const e=a.toLowerCase();return e.includes("unauthorized")||e.includes("expired")||e.includes("no saved token")||e.includes("invalid")||e.includes("pairing")}async function ce(){const e=new URL(window.location.href).searchParams.get("pair");if(e)try{const n=await V(e);try{await X(n)}catch{}return await new R(n).home(),n}catch{}try{const n=await Q();if(n&&n.length>0)return await new R(n).home(),n}catch{try{await J()}catch{}}throw new Error("No saved token. Send /files in Telegram to get started.")}function le(a,e){a.replaceChildren();const n=document.createElement("div");n.className="status-message";const o=document.createElement("div");o.style.fontSize="48px",o.style.marginBottom="12px",o.textContent="ðŸ”‘";const t=document.createElement("div");t.style.fontWeight="600",t.style.fontSize="16px",t.style.marginBottom="8px",t.textContent="Session Expired";const i=document.createElement("div");i.style.marginBottom="16px",i.textContent="Send /files in Telegram to get a new link.";const r=document.createElement("button");r.style.cssText="padding:10px 24px;border-radius:8px;border:none;background:var(--tg-theme-button-color);color:var(--tg-theme-button-text-color);font-size:14px;font-weight:600;cursor:pointer;",r.textContent="Close",r.addEventListener("click",()=>e.close()),n.appendChild(o),n.appendChild(t),n.appendChild(i),n.appendChild(r),a.appendChild(n)}function G(a,e,n=!1){a.replaceChildren();const o=document.createElement("div");o.className=`status-message ${n?"error-text":""}`,o.textContent=e,a.appendChild(o)}se();
